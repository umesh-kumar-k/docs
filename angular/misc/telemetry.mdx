# OpenTelemetry in Angular - **COMPLETE Implementation Guide**

**OpenTelemetry**: Vendor-neutral **traces/metrics/logs** for Angular. **SigNoz** backend. **Auto-instrumentation** + custom spans. **Zone.js** integration critical.[1]

## **ðŸ“‹ SECTION-BY-SECTION BREAKDOWN**

### **1. Core Concepts**
**Why Angular OTel**:
- **End-to-end tracing**: UI â†’ API â†’ Backend
- **Vendor-neutral**: Switch SigNoz/New Relic freely
- **3 Pillars**: Traces (spans), Metrics (counters), Logs

**SigNoz Integration**:
```
Ingestion: https://ingest.{REGION}.signoz.cloud:443/v1/traces
Headers: {'signoz-ingestion-key': KEY}
```

### **2. Setup Steps**
**Packages** (`^1.21.0` web, `^0.48.0` others):
```
@opentelemetry/sdk-trace-web
@opentelemetry/auto-instrumentations-web
@opentelemetry/exporter-trace-otlp-http
@opentelemetry/resources
```

**instrument.ts Structure**:
```typescript
// 1. Resource (service name/version)
const resource = Resource.default().merge(new Resource({
  [SemanticResourceAttributes.SERVICE_NAME]: 'angular-app'
}));

// 2. TracerProvider
const provider = new WebTracerProvider({ resource });

// 3. SpanProcessors (Console + OTLP Batch)
provider.addSpanProcessor(new BatchSpanProcessor(new OTLPTraceExporter({
  url: 'https://ingest.us.signoz.cloud:443/v1/traces',
  headers: { 'signoz-ingestion-key': 'key' }
})));

// 4. Propagator (B3/W3C)
provider.register({ propagator: new B3Propagator() });

// 5. Auto-instrumentations
registerInstrumentations({
  instrumentations: [getWebAutoInstrumentations({
    '@opentelemetry/instrumentation-fetch': { propagateTraceHeaderCorsUrls: /.+/ }
  })]
});

// 6. Metrics
const meterProvider = new MeterProvider({ resource });
opentelemetry.metrics.setGlobalMeterProvider(meterProvider);
```

**main.ts**: `import './app/instrument';`

### **3. Key Classes/Interfaces**
| Class | Purpose | Config |
|-------|---------|---------|
| **WebTracerProvider** | Core tracer | `{resource, sampler}` |
| **BatchSpanProcessor** | Export spans | `{maxQueueSize:100, scheduledDelayMillis:500}` |
| **OTLPTraceExporter** | SigNoz endpoint | `{url, headers}` |
| **Resource** | Service metadata | `SERVICE_NAME, SERVICE_VERSION` |
| **B3Propagator** | Trace context | Header propagation |

### **4. Benefits & Use Cases**
| Benefit | Impact | Use Case |
|---------|---------|----------|
| **End-to-end** | 30-50% latency â†“ | UIâ†’APIâ†’DB trace |
| **Vendor neutral** | 40-60% cost â†“ | SigNozâ†”New Relic |
| **Custom metrics** | 10-20% conversion â†‘ | Cart abandonment |
| **Error context** | 40-60% debug â†“ | Full trace on crash |

## **Design Patterns**

**1. Span Wrapper (Decorator)**:
```typescript
function traceSpan(operation: string) {
  return function(target: any, propertyKey: string, descriptor: PropertyDescriptor) {
    const original = descriptor.value;
    descriptor.value = async function(...args: any[]) {
      const span = trace.getTracer('angular').startSpan(operation);
      try {
        const result = await original.apply(this, args);
        span.setAttributes({ result: 'success' });
        return result;
      } catch (error) {
        span.recordException(error);
        throw error;
      } finally {
        span.end();
      }
    };
  };
}
```

**2. ZoneContextManager**: Angular Zone.js + OTel context sync

## **Best Practices**

| Category | Practice |
|----------|----------|
| **Sampling** | `ParentBasedSampler({root: new TraceIdRatioBasedSampler(0.1)})` |
| **Batching** | `maxQueueSize:100, scheduledDelayMillis:500` |
| **Security** | HTTPS, no PII in spans, auth headers |
| **Performance** | Async spans, critical paths only |
| **Error Handling** | `span.recordException(error)` + `finally { span.end() }` |

**Production Config**:
```
sampler: 10% traces
batch: 10 spans, 500ms delay
resource: env=production
```

## **Common Challenges**

| Issue | Solution |
|-------|----------|
| **Context loss** | `ZoneContextManager` + `W3CTraceContextPropagator` |
| **Async gaps** | Manual `startSpan` in promises |
| **3rd party** | Wrap methods or use auto-instr |
| **No data** | CORS, endpoint URL, wait 10s |

## **Interview Cheat Sheet**

**Q: Core OTel Angular packages?**  
A: `sdk-trace-web`, `auto-instrumentations-web`, `exporter-trace-otlp-http`[1]

**Q: instrument.ts import location?**  
A: `main.ts: import './app/instrument';` (app bootstrap)[1]

**Q: Propagator for backend correlation?**  
A: **B3Propagator** (Zipkin) or **W3CTraceContextPropagator**[1]

**Q: Production sampling strategy?**  
A: `ParentBasedSampler(root: TraceIdRatioBasedSampler(0.1))` (10%)[1]

**Q: Angular Zone.js issue?**  
A: `@opentelemetry/context-zone` + `ZoneContextManager`[1]

**Q: Span lifecycle?**  
A: `startSpan` â†’ `setAttributes/recordException` â†’ `end()`[1]

**Q: SigNoz regions?**  
A: US/IN/EU â†’ `ingest.{region}.signoz.cloud:443/v1/traces`[1]

## **Important Terms & Keywords**

**Core Classes (8)**:
- **WebTracerProvider**, **BatchSpanProcessor**, **OTLPTraceExporter**
- **Resource**, **SemanticResourceAttributes** (SERVICE_NAME/VERSION)
- **B3Propagator**, **W3CTraceContextPropagator**
- **MeterProvider**, **PeriodicExportingMetricReader**

**Auto-Instrumentations (5)**:
- `document-load`, `user-interaction`, `fetch`, `xml-http-request`
- `propagateTraceHeaderCorsUrls: /.+/`

**Patterns/Config (7)**:
- **ZoneContextManager**, **ParentBasedSampler**, **TraceIdRatioBasedSampler**
- `maxQueueSize`, `scheduledDelayMillis`, `exportIntervalMillis:6000`
- **span.recordException**, **span.setAttributes**

**Challenges/Solutions (5)**:
- **Context propagation**, CORS, async gaps
- Manual spans, 3rd-party wrapping
- HTTPS, no PII, auth headers[1]

[1](https://signoz.io/blog/opentelemetry-angular/)